@inline function calculate_differential(
    x0::T, x1::T, x2::T, x3::T, v0::T, v1::T, v2::T, v3::T,
    metric::KerrMetric{T}) where {T}

    a = metric.a
    M = metric.M
    #block for macro application...
    @fastmath @inbounds begin

        #code generated by FastDifferentation.jl - need to find a way to automate this for arbitrary metrics.
        var"##243" = x1 * x1
        var"##244" = x2 * x2
        var"##242" = var"##243" + var"##244"
        var"##245" = x3 * x3
        var"##241" = var"##242" + var"##245"
        var"##246" = a * a
        var"##240" = var"##241" - var"##246"
        var"##249" = var"##240" ^ 2
        var"##251" = 4.0f0var"##246"
        var"##250" = var"##251" * var"##245"
        var"##248" = var"##249" + var"##250"
        var"##247" = sqrt(var"##248")
        var"##239" = var"##240" + var"##247"
        var"##238" = var"##239" * M
        var"##237" = -var"##238"
        var"##253" = 0.5f0var"##239"
        var"##252" = sqrt(var"##253")
        var"##236" = var"##237" * var"##252"
        var"##256" = var"##239" * var"##239"
        var"##255" = 0.25f0var"##256"
        var"##257" = var"##246" * var"##245"
        var"##254" = var"##255" + var"##257"
        var"##235" = var"##236" / var"##254"
        var"##234" = -1 + var"##235"
        var"##233" = var"##234" * v0
        var"##260" = -var"##235"
        var"##263" = var"##252" * x1
        var"##264" = a * x2
        var"##262" = var"##263" + var"##264"
        var"##265" = var"##253" + var"##246"
        var"##261" = var"##262" / var"##265"
        var"##259" = var"##260" * var"##261"
        var"##258" = var"##259" * v1
        var"##232" = var"##233" + var"##258"
        var"##270" = var"##252" * x2
        var"##271" = a * x1
        var"##269" = var"##270" - var"##271"
        var"##268" = var"##269" / var"##265"
        var"##267" = var"##260" * var"##268"
        var"##266" = var"##267" * v2
        var"##231" = var"##232" + var"##266"
        var"##274" = x3 / var"##252"
        var"##273" = var"##260" * var"##274"
        var"##272" = var"##273" * v3
        var"##230" = var"##231" + var"##272"
        dx0 = var"##230"
        var"##278" = var"##259" * v0
        var"##282" = var"##235" * var"##261"
        var"##281" = var"##282" * var"##261"
        var"##280" = 1 + var"##281"
        var"##279" = var"##280" * v1
        var"##277" = var"##278" + var"##279"
        var"##284" = var"##268" * var"##282"
        var"##283" = var"##284" * v2
        var"##276" = var"##277" + var"##283"
        var"##286" = var"##274" * var"##282"
        var"##285" = var"##286" * v3
        var"##275" = var"##276" + var"##285"
        dx1 = var"##275"
        var"##290" = var"##267" * v0
        var"##291" = var"##284" * v1
        var"##289" = var"##290" + var"##291"
        var"##295" = var"##235" * var"##268"
        var"##294" = var"##295" * var"##268"
        var"##293" = 1 + var"##294"
        var"##292" = var"##293" * v2
        var"##288" = var"##289" + var"##292"
        var"##297" = var"##295" * var"##274"
        var"##296" = var"##297" * v3
        var"##287" = var"##288" + var"##296"
        dx2 = var"##287"
        var"##301" = var"##273" * v0
        var"##302" = var"##286" * v1
        var"##300" = var"##301" + var"##302"
        var"##303" = var"##297" * v2
        var"##299" = var"##300" + var"##303"
        var"##307" = var"##235" * var"##274"
        var"##306" = var"##307" * var"##274"
        var"##305" = 1 + var"##306"
        var"##304" = var"##305" * v3
        var"##298" = var"##299" + var"##304"
        dx3 = var"##298"
        dv0 = 0
        var"##320" = 1 / var"##265"
        var"##319" = var"##320" * x2
        var"##322" = 2var"##252"
        var"##321" = 1 / var"##322"
        var"##318" = var"##319" * var"##321"
        var"##324" = var"##268" / var"##265"
        var"##323" = -var"##324"
        var"##317" = var"##318" + var"##323"
        var"##329" = v2 * var"##268"
        var"##328" = v2 * var"##329"
        var"##332" = v2 * v3
        var"##333" = v3 * v2
        var"##331" = var"##332" + var"##333"
        var"##330" = var"##331" * var"##274"
        var"##327" = var"##328" + var"##330"
        var"##326" = var"##235" * var"##327"
        var"##337" = v1 * v2
        var"##338" = v2 * v1
        var"##336" = var"##337" + var"##338"
        var"##335" = var"##282" * var"##336"
        var"##340" = var"##295" * v2
        var"##339" = var"##340" * v2
        var"##334" = var"##335" + var"##339"
        var"##325" = var"##326" + var"##334"
        var"##316" = var"##317" * var"##325"
        var"##342" = 3var"##321"
        var"##346" = var"##274" / var"##252"
        var"##345" = -var"##346"
        var"##344" = 2var"##345"
        var"##352" = v1 * v3
        var"##353" = v3 * v1
        var"##351" = var"##352" + var"##353"
        var"##350" = var"##282" * var"##351"
        var"##354" = var"##295" * var"##331"
        var"##349" = var"##350" + var"##354"
        var"##357" = 2var"##307"
        var"##356" = var"##357" * v3
        var"##355" = var"##356" * v3
        var"##348" = var"##349" + var"##355"
        var"##359" = v3 * v0
        var"##358" = var"##260" * var"##359"
        var"##347" = var"##348" + var"##358"
        var"##343" = var"##344" * var"##347"
        var"##341" = var"##342" * var"##343"
        var"##315" = var"##316" + var"##341"
        var"##314" = 2.0f0var"##315"
        var"##364" = 1 / var"##254"
        var"##367" = -var"##252"
        var"##366" = var"##367" * M
        var"##369" = var"##237" * var"##321"
        var"##368" = 0.5f0var"##369"
        var"##365" = var"##366" + var"##368"
        var"##363" = var"##364" * var"##365"
        var"##373" = var"##235" / var"##254"
        var"##372" = -var"##373"
        var"##371" = var"##239" * var"##372"
        var"##370" = 0.5f0var"##371"
        var"##362" = var"##363" + var"##370"
        var"##361" = 2var"##362"
        var"##378" = var"##268" * var"##327"
        var"##381" = var"##274" * var"##274"
        var"##380" = var"##381" * v3
        var"##379" = var"##380" * v3
        var"##377" = var"##378" + var"##379"
        var"##384" = 2var"##274"
        var"##383" = var"##384" * var"##359"
        var"##382" = -4var"##383"
        var"##376" = var"##377" + var"##382"
        var"##389" = var"##261" * v1
        var"##388" = var"##389" * v1
        var"##390" = var"##268" * var"##336"
        var"##387" = var"##388" + var"##390"
        var"##391" = var"##274" * var"##351"
        var"##386" = var"##387" + var"##391"
        var"##385" = var"##261" * var"##386"
        var"##375" = var"##376" + var"##385"
        var"##395" = v2 * v0
        var"##396" = -var"##268"
        var"##394" = var"##395" * var"##396"
        var"##399" = v1 * v0
        var"##400" = -var"##261"
        var"##398" = var"##399" * var"##400"
        var"##404" = v3 * var"##274"
        var"##403" = -var"##404"
        var"##408" = v1 * var"##261"
        var"##407" = -var"##408"
        var"##406" = v0 + var"##407"
        var"##409" = -var"##329"
        var"##405" = var"##406" + var"##409"
        var"##402" = var"##403" + var"##405"
        var"##401" = v0 * var"##402"
        var"##397" = var"##398" + var"##401"
        var"##393" = var"##394" + var"##397"
        var"##410" = v0 * v0
        var"##392" = var"##393" + var"##410"
        var"##374" = var"##375" + var"##392"
        var"##360" = var"##361" * var"##374"
        var"##313" = var"##314" + var"##360"
        var"##411" = 2 * x1
        var"##312" = var"##313" * var"##411"
        var"##416" = -(a)
        var"##418" = x2 * var"##321"
        var"##417" = x1 * var"##418"
        var"##415" = var"##416" + var"##417"
        var"##414" = var"##320" * var"##415"
        var"##419" = x1 * var"##323"
        var"##413" = var"##414" + var"##419"
        var"##412" = var"##325" * var"##413"
        var"##311" = var"##312" + var"##412"
        var"##423" = var"##362" * var"##411"
        var"##422" = var"##261" * var"##423"
        var"##429" = x1 * var"##321"
        var"##428" = x1 * var"##429"
        var"##427" = var"##252" + var"##428"
        var"##426" = var"##320" * var"##427"
        var"##432" = var"##261" / var"##265"
        var"##431" = -var"##432"
        var"##430" = x1 * var"##431"
        var"##425" = var"##426" + var"##430"
        var"##424" = var"##235" * var"##425"
        var"##421" = var"##422" + var"##424"
        var"##420" = var"##386" * var"##421"
        var"##310" = var"##311" + var"##420"
        var"##436" = var"##260" * var"##413"
        var"##438" = var"##396" * var"##362"
        var"##437" = var"##438" * var"##411"
        var"##435" = var"##436" + var"##437"
        var"##434" = var"##395" * var"##435"
        var"##442" = v1 * v1
        var"##441" = var"##442" * var"##282"
        var"##440" = var"##441" * var"##425"
        var"##445" = var"##260" * var"##425"
        var"##447" = var"##400" * var"##362"
        var"##446" = var"##447" * var"##411"
        var"##444" = var"##445" + var"##446"
        var"##443" = var"##399" * var"##444"
        var"##439" = var"##440" + var"##443"
        var"##433" = var"##434" + var"##439"
        var"##309" = var"##310" + var"##433"
        var"##308" = -0.5f0var"##309"
        dv1 = var"##308"
        var"##453" = 2 * x2
        var"##452" = var"##313" * var"##453"
        var"##458" = x2 * var"##418"
        var"##457" = var"##252" + var"##458"
        var"##456" = var"##320" * var"##457"
        var"##459" = var"##323" * x2
        var"##455" = var"##456" + var"##459"
        var"##454" = var"##325" * var"##455"
        var"##451" = var"##452" + var"##454"
        var"##463" = var"##362" * var"##453"
        var"##462" = var"##261" * var"##463"
        var"##468" = x2 * var"##429"
        var"##467" = a + var"##468"
        var"##466" = var"##320" * var"##467"
        var"##469" = var"##431" * x2
        var"##465" = var"##466" + var"##469"
        var"##464" = var"##235" * var"##465"
        var"##461" = var"##462" + var"##464"
        var"##460" = var"##386" * var"##461"
        var"##450" = var"##451" + var"##460"
        var"##473" = var"##260" * var"##455"
        var"##476" = -var"##362"
        var"##475" = var"##476" * var"##453"
        var"##474" = var"##268" * var"##475"
        var"##472" = var"##473" + var"##474"
        var"##471" = var"##395" * var"##472"
        var"##478" = var"##441" * var"##465"
        var"##481" = var"##260" * var"##465"
        var"##482" = var"##447" * var"##453"
        var"##480" = var"##481" + var"##482"
        var"##479" = var"##399" * var"##480"
        var"##477" = var"##478" + var"##479"
        var"##470" = var"##471" + var"##477"
        var"##449" = var"##450" + var"##470"
        var"##448" = -0.5f0var"##449"
        dv2 = var"##448"
        var"##493" = 2var"##247"
        var"##492" = 1 / var"##493"
        var"##491" = var"##492" * var"##251"
        var"##490" = var"##491" + 1
        var"##489" = var"##313" * var"##490"
        var"##497" = var"##365" * var"##490"
        var"##496" = var"##364" * var"##497"
        var"##500" = var"##253" * var"##490"
        var"##499" = var"##246" + var"##500"
        var"##498" = var"##372" * var"##499"
        var"##495" = var"##496" + var"##498"
        var"##494" = var"##374" * var"##495"
        var"##488" = var"##489" + var"##494"
        var"##503" = var"##261" * var"##495"
        var"##509" = var"##320" * x1
        var"##508" = var"##509" * var"##321"
        var"##507" = var"##508" + var"##431"
        var"##506" = 0.5f0var"##507"
        var"##505" = var"##506" * var"##490"
        var"##504" = var"##235" * var"##505"
        var"##502" = var"##503" + var"##504"
        var"##501" = var"##386" * var"##502"
        var"##487" = var"##488" + var"##501"
        var"##510" = 2 * x3
        var"##486" = var"##487" * var"##510"
        var"##513" = 1 / var"##252"
        var"##517" = 0.5f0var"##321"
        var"##516" = var"##517" * var"##490"
        var"##515" = var"##516" * var"##510"
        var"##514" = var"##345" * var"##515"
        var"##512" = var"##513" + var"##514"
        var"##511" = var"##347" * var"##512"
        var"##485" = var"##486" + var"##511"
        var"##524" = 0.5f0var"##317"
        var"##523" = var"##524" * var"##490"
        var"##522" = var"##260" * var"##523"
        var"##526" = -var"##495"
        var"##525" = var"##268" * var"##526"
        var"##521" = var"##522" + var"##525"
        var"##520" = var"##521" * var"##510"
        var"##519" = var"##395" * var"##520"
        var"##532" = var"##441" * var"##507"
        var"##531" = 0.5f0var"##532"
        var"##530" = var"##531" * var"##490"
        var"##536" = 0.5f0var"##260"
        var"##537" = var"##507" * var"##490"
        var"##535" = var"##536" * var"##537"
        var"##538" = var"##400" * var"##495"
        var"##534" = var"##535" + var"##538"
        var"##533" = var"##399" * var"##534"
        var"##529" = var"##530" + var"##533"
        var"##539" = var"##410" * var"##495"
        var"##528" = var"##529" + var"##539"
        var"##527" = var"##528" * var"##510"
        var"##518" = var"##519" + var"##527"
        var"##484" = var"##485" + var"##518"
        var"##483" = -0.5f0var"##484"
        dv3 = var"##483"

    end
    
    return dx0, dx1, dx2, dx3, dv0, dv1, dv2, dv3

end

@inline function calculate_differential(state::NTuple{8, T}, metric::KerrMetric{T}) where T
    x0, x1, x2, x3, v0, v1, v2, v3 = state
    dstate = calculate_differential(x0, x1, x2, x3, v0, v1, v2, v3, metric)
    return dstate
end

@inline function yield_r2(x0::T, x1::T, x2::T, x3::T, metric::KerrMetric{T}) where T

    a = metric.a
    M = metric.M
    @fastmath begin
        x1_2 = x1*x1
        x2_2 = x2*x2
        x3_2 = x3*x3
        R2 = x1_2 + x2_2 + x3_2
        a2 = a*a
        sub1 = R2 - a2
        r2 = T(0.5) * (sub1 + sqrt(sub1^2 + T(4) * a2 * x3_2))
    end

    return r2

end

@inline function RK4step(x0::T, x1::T, x2::T, x3::T, v0::T, v1::T, v2::T, v3::T, metric::KerrMetric{T}, dt::T) where T

    #ould use a tuple based abstrction here, but I am paranoid about allocations or spilling
    state = (x0, x1, x2, x3, v0, v1, v2, v3)
    @fastmath begin 
        dstate_1 = calculate_differential(state, metric)
        dstate_2 = calculate_differential(state .+ dt * T(0.5) * dstate_1, metric)
        dstate_3 = calculate_differential(state .+ dt * T(0.5) * dstate_2, metric)
        dstate_4 = calculate_differential(state .+ dt * dstate_3, metric)
        newstate = state .+ T(dt/6) * (dstate_1 + 2*dstate_2 + 2*dstate_3 + dstate_4)
    end
    return newstate
end